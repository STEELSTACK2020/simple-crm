{% extends "base.html" %}

{% block title %}{{ deal.name }} - Simple CRM{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="/deals" class="text-slate-800 hover:text-slate-900 text-sm">&larr; Back to Pipeline</a>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Deal Info -->
    <div class="lg:col-span-2 space-y-6">
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b gradient-bg flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-white">{{ deal.name }}</h1>
                    <p class="text-slate-200">Created {{ deal.created_at|format_date }}</p>
                </div>
                <div class="flex gap-2">
                    <a href="/deals/{{ deal.id }}/edit" class="bg-white text-slate-800 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-100">
                        Edit Deal
                    </a>
                </div>
            </div>

            <div class="p-6">
                <!-- Deal Value & Stage -->
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                    <div>
                        <p class="text-gray-500 text-sm">Value</p>
                        <p class="text-3xl font-bold text-slate-800">${{ "{:,.0f}".format(deal.value) }}</p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Stage</p>
                        <span class="inline-block mt-1 px-3 py-1 rounded-full text-sm font-medium
                            {% if deal.stage == 'new_deal' %}bg-blue-100 text-blue-800
                            {% elif deal.stage == 'proposal' %}bg-slate-100 text-slate-900
                            {% elif deal.stage == 'negotiation' %}bg-yellow-100 text-yellow-800
                            {% elif deal.stage == 'closed_won' %}bg-green-100 text-green-800
                            {% elif deal.stage == 'closed_lost' %}bg-red-100 text-red-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {% if deal.stage == 'new_deal' %}New Deal
                            {% elif deal.stage == 'closed_won' %}Closed Won
                            {% elif deal.stage == 'closed_lost' %}Closed Lost
                            {% else %}{{ deal.stage|replace('_', ' ')|title }}{% endif %}
                        </span>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Salesperson</p>
                        <p class="text-lg font-medium">{{ deal.salesperson or 'Unassigned' }}</p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Expected Close</p>
                        <p class="text-lg font-medium">{{ deal.expected_close_date|format_date if deal.expected_close_date else 'Not set' }}</p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Actual Close</p>
                        <p class="text-lg font-medium">{{ deal.actual_close_date|format_date if deal.actual_close_date else '-' }}</p>
                    </div>
                </div>

                <!-- Win/Loss Reason (for closed deals) -->
                {% if deal.stage in ['closed_won', 'closed_lost'] %}
                <div class="mb-6 p-4 rounded-lg {{ 'bg-green-50 border border-green-200' if deal.stage == 'closed_won' else 'bg-red-50 border border-red-200' }}">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-sm font-medium {{ 'text-green-800' if deal.stage == 'closed_won' else 'text-red-800' }}">
                                {{ 'Win' if deal.stage == 'closed_won' else 'Loss' }} Reason
                            </h3>
                            {% if deal.close_reason %}
                            <p class="mt-1 text-gray-700">{{ deal.close_reason }}</p>
                            {% else %}
                            <p class="mt-1 text-gray-500 italic">No reason recorded</p>
                            {% endif %}
                        </div>
                        <button onclick="document.getElementById('reasonModal').classList.remove('hidden')"
                                class="text-sm {{ 'text-green-700 hover:text-green-900' if deal.stage == 'closed_won' else 'text-red-700 hover:text-red-900' }}">
                            {{ 'Edit' if deal.close_reason else 'Add reason' }}
                        </button>
                    </div>
                </div>
                {% endif %}

                <!-- UTM Source Info -->
                {% if deal.utm_source or deal.utm_medium or deal.utm_campaign %}
                <div class="border-t pt-4 mb-6">
                    <h3 class="text-sm font-medium text-gray-500 mb-2">Lead Source</h3>
                    <div class="flex flex-wrap gap-2">
                        {% if deal.utm_source %}
                        <span class="bg-slate-100 text-slate-900 px-3 py-1 rounded-full text-sm">
                            Source: {{ deal.utm_source }}
                        </span>
                        {% endif %}
                        {% if deal.utm_medium %}
                        <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm">
                            Medium: {{ deal.utm_medium }}
                        </span>
                        {% endif %}
                        {% if deal.utm_campaign %}
                        <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm">
                            Campaign: {{ deal.utm_campaign }}
                        </span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Notes -->
                {% if deal.notes %}
                <div class="border-t pt-4">
                    <h3 class="text-sm font-medium text-gray-500 mb-2">Notes</h3>
                    <p class="text-gray-700 whitespace-pre-wrap">{{ deal.notes }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Lead Source - SALESPERSON INPUT -->
        <div class="rounded-lg shadow p-6 {% if deal.reported_source %}bg-white{% else %}bg-red-50 border-2 border-red-300{% endif %}">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold {% if deal.reported_source %}text-gray-900{% else %}text-red-700{% endif %}">
                    {% if deal.reported_source %}
                    ✓ Customer Said
                    {% else %}
                    ⚠️ ASK: "How did you hear about us?"
                    {% endif %}
                </h3>
                {% if deal.reported_source %}
                <span class="inline-flex items-center text-sm font-medium px-3 py-1 rounded bg-blue-100 text-blue-700">
                    {{ deal.reported_source }}
                </span>
                {% endif %}
            </div>

            {% if not deal.reported_source %}
            <p class="text-red-600 text-sm mb-3 font-medium">Record what the customer tells you!</p>
            {% endif %}

            <form method="POST" action="/deals/{{ deal.id }}/reported-source" class="flex gap-2">
                <input type="text" name="reported_source" value="{{ deal.reported_source or '' }}"
                       placeholder="Type what customer said... (e.g., 'Found you on YouTube')"
                       class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-700">
                <button type="submit" class="px-4 py-2 rounded-lg text-sm font-medium {% if deal.reported_source %}bg-gray-200 text-gray-700 hover:bg-gray-300{% else %}bg-red-600 text-white hover:bg-red-700{% endif %}">
                    {% if deal.reported_source %}Update{% else %}Save{% endif %}
                </button>
            </form>
        </div>

        <!-- Quick Stage Update -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="font-semibold text-gray-900 mb-4">Update Stage</h3>
            <div class="flex flex-wrap gap-2">
                {% for stage in ['new_deal', 'proposal', 'negotiation', 'closed_won', 'closed_lost'] %}
                <form method="POST" action="/deals/{{ deal.id }}/stage" class="inline">
                    <input type="hidden" name="stage" value="{{ stage }}">
                    <button type="submit" class="px-4 py-2 rounded-lg text-sm font-medium
                        {% if deal.stage == stage %}
                            {% if stage == 'new_deal' %}bg-blue-600 text-white
                            {% elif stage == 'closed_won' %}bg-green-600 text-white
                            {% elif stage == 'closed_lost' %}bg-red-600 text-white
                            {% else %}bg-slate-800 text-white{% endif %}
                        {% else %}
                            {% if stage == 'new_deal' %}bg-blue-100 text-blue-700 hover:bg-blue-200
                            {% elif stage == 'closed_won' %}bg-green-100 text-green-700 hover:bg-green-200
                            {% elif stage == 'closed_lost' %}bg-red-100 text-red-700 hover:bg-red-200
                            {% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}
                        {% endif %}">
                        {% if stage == 'new_deal' %}New Deal
                        {% elif stage == 'closed_won' %}Closed Won
                        {% elif stage == 'closed_lost' %}Closed Lost
                        {% else %}{{ stage|replace('_', ' ')|title }}{% endif %}
                    </button>
                </form>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Sidebar - Contacts -->
    <div class="space-y-6">
        <div class="bg-white rounded-lg shadow" style="overflow: visible;">
            <div class="px-4 py-3 border-b bg-gray-50 rounded-t-lg">
                <h3 class="font-semibold text-gray-900">Contacts ({{ deal.contacts|length }})</h3>
            </div>
            <div class="p-4" style="overflow: visible;">
                {% if deal.contacts %}
                <div class="space-y-3">
                    {% for contact in deal.contacts %}
                    <a href="/contacts/{{ contact.id }}" class="block p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                        <p class="font-medium text-gray-900">{{ contact.first_name }} {{ contact.last_name }}</p>
                        <p class="text-sm text-gray-500">{{ contact.email }}</p>
                        {% if contact.phone %}
                        <p class="text-sm text-gray-500">{{ contact.phone }}</p>
                        {% endif %}
                        <span class="text-xs text-slate-800 capitalize">{{ contact.role }}</span>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-sm">No contacts linked to this deal.</p>
                {% endif %}

                <!-- Add Contact Form -->
                <div class="mt-4 pt-4 border-t">
                    <form method="POST" action="/deals/{{ deal.id }}/contacts/add" id="link-contact-form">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Link Contact</label>

                        <!-- Searchable contact input -->
                        <div class="relative mb-2" style="position: relative;">
                            <input type="hidden" name="contact_id" id="contact-id-input" value="">
                            <input type="text" id="contact-search"
                                   placeholder="Click to see contacts or type to search..."
                                   autocomplete="off"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-700">
                            <div id="contact-results" class="hidden bg-white border border-gray-300 rounded-lg max-h-60 overflow-y-auto shadow-xl"
                                 style="position: absolute; top: 100%; left: 0; right: 0; z-index: 9999; margin-top: 4px;">
                                <!-- Search results appear here -->
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-slate-800 text-white px-3 py-2 rounded-lg text-sm hover:bg-slate-900">
                            Add Contact
                        </button>
                    </form>
                    <a href="/contacts/add" class="block w-full text-center text-slate-600 hover:text-slate-800 text-sm mt-2">
                        + Create New Contact
                    </a>
                </div>
            </div>
        </div>

        <!-- Quotes -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-4 py-3 border-b bg-gray-50 flex justify-between items-center">
                <h3 class="font-semibold text-gray-900">Quotes ({{ deal.quotes|length if deal.quotes else 0 }})</h3>
            </div>
            <div class="p-4">
                {% if deal.quotes %}
                <div class="space-y-3">
                    {% for quote in deal.quotes %}
                    <a href="/quotes/{{ quote.id }}/edit" class="block p-3 rounded-lg hover:bg-gray-100 border
                        {% if quote.status == 'accepted' %}bg-green-50 border-green-200
                        {% elif quote.status == 'sent' %}bg-blue-50 border-blue-200
                        {% elif quote.status == 'declined' %}bg-red-50 border-red-200
                        {% else %}bg-gray-50 border-gray-200{% endif %}">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-medium text-gray-900">{{ quote.quote_number }}</p>
                                <p class="text-sm text-gray-600">{{ quote.title }}</p>
                            </div>
                            <span class="text-sm font-medium
                                {% if quote.status == 'accepted' %}text-green-700
                                {% elif quote.status == 'sent' %}text-blue-700
                                {% elif quote.status == 'declined' %}text-red-700
                                {% else %}text-gray-600{% endif %}">
                                {{ quote.status|title }}
                            </span>
                        </div>
                        <p class="text-lg font-bold text-slate-800 mt-2">${{ '{:,.2f}'.format(quote.total or 0) }}</p>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-sm">No quotes created yet.</p>
                {% endif %}

                <div class="mt-4 pt-4 border-t">
                    <a href="/quotes/add?deal_id={{ deal.id }}" class="block w-full text-center bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700">
                        + Create Quote
                    </a>
                </div>
            </div>
        </div>

        <!-- Delete Deal -->
        <div class="bg-white rounded-lg shadow p-4">
            <form method="POST" action="/deals/{{ deal.id }}/delete" onsubmit="return confirm('Are you sure you want to delete this deal?');">
                <button type="submit" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-700">
                    Delete Deal
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Close Reason Modal -->
{% if deal.stage in ['closed_won', 'closed_lost'] %}
<div id="reasonModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="px-6 py-4 border-b">
            <h3 class="text-lg font-semibold text-gray-900">
                {{ 'Win' if deal.stage == 'closed_won' else 'Loss' }} Reason
            </h3>
        </div>
        <form method="POST" action="/deals/{{ deal.id }}/reason">
            <div class="p-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Why did this deal {{ 'close successfully' if deal.stage == 'closed_won' else 'not close' }}?
                </label>
                <textarea name="close_reason" rows="4"
                          placeholder="e.g., {{ 'Great pricing, met their timeline' if deal.stage == 'closed_won' else 'Went with competitor, budget constraints' }}"
                          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-slate-700">{{ deal.close_reason or '' }}</textarea>

                {% if deal.stage == 'closed_won' %}
                <div class="mt-3">
                    <p class="text-sm text-gray-500 mb-2">Quick select:</p>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" onclick="setReason('Best pricing')" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200">Best pricing</button>
                        <button type="button" onclick="setReason('Great relationship')" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200">Great relationship</button>
                        <button type="button" onclick="setReason('Product fit')" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200">Product fit</button>
                        <button type="button" onclick="setReason('Timeline aligned')" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200">Timeline aligned</button>
                    </div>
                </div>
                {% else %}
                <div class="mt-3">
                    <p class="text-sm text-gray-500 mb-2">Quick select:</p>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" onclick="setReason('Went with competitor')" class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200">Went with competitor</button>
                        <button type="button" onclick="setReason('Budget constraints')" class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200">Budget constraints</button>
                        <button type="button" onclick="setReason('Project cancelled')" class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200">Project cancelled</button>
                        <button type="button" onclick="setReason('No response')" class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200">No response</button>
                        <button type="button" onclick="setReason('Timing not right')" class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200">Timing not right</button>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="px-6 py-4 border-t bg-gray-50 flex justify-end gap-3">
                <button type="button" onclick="document.getElementById('reasonModal').classList.add('hidden')"
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900">
                    Save Reason
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function setReason(text) {
    document.querySelector('textarea[name="close_reason"]').value = text;
}

// Close modal on escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.getElementById('reasonModal').classList.add('hidden');
    }
});

// Close modal on background click
document.getElementById('reasonModal').addEventListener('click', function(e) {
    if (e.target === this) {
        this.classList.add('hidden');
    }
});
</script>
{% endif %}

<!-- Contact Search Script -->
<script>
    // Contacts data for search (excluding already linked contacts)
    const linkedContactIds = [{% for contact in deal.contacts %}{{ contact.id }}{{ ',' if not loop.last else '' }}{% endfor %}];
    const allContactsData = [
        {% for contact in all_contacts %}
        {
            id: {{ contact.id }},
            firstName: "{{ contact.first_name|default('', true) }}",
            lastName: "{{ contact.last_name|default('', true) }}",
            name: "{{ contact.first_name|default('', true) }} {{ contact.last_name|default('', true) }}".trim(),
            email: "{{ contact.email|default('', true) }}"
        }{{ ',' if not loop.last else '' }}
        {% endfor %}
    ].filter(c => !linkedContactIds.includes(c.id));

    const contactSearch = document.getElementById('contact-search');
    const contactResults = document.getElementById('contact-results');
    const contactIdInput = document.getElementById('contact-id-input');
    const linkContactForm = document.getElementById('link-contact-form');

    // Show contacts in dropdown
    function showContacts(filterQuery = '') {
        const query = filterQuery.toLowerCase().trim();
        let matches;

        if (query.length < 1) {
            // Show most recent contacts (first 10)
            matches = allContactsData.slice(0, 10);
        } else {
            // Filter by search query
            matches = allContactsData.filter(c =>
                c.name.toLowerCase().includes(query) ||
                c.email.toLowerCase().includes(query)
            ).slice(0, 10);
        }

        if (matches.length === 0) {
            contactResults.innerHTML = '<div class="px-3 py-2 text-gray-500 text-sm">No contacts found</div>';
        } else {
            contactResults.innerHTML = matches.map(c => `
                <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm border-b last:border-b-0"
                     onclick="selectContact(${c.id}, '${c.name.replace(/'/g, "\\'")}', '${c.email}')">
                    <div class="font-medium text-gray-900">${c.name || '(No name)'}</div>
                    <div class="text-xs text-gray-500">${c.email || '(No email)'}</div>
                </div>
            `).join('');
        }
        contactResults.classList.remove('hidden');
    }

    if (contactSearch) {
        // Show recent contacts when clicking/focusing on the box
        contactSearch.addEventListener('focus', function() {
            showContacts(this.value);
        });

        // Filter as user types
        contactSearch.addEventListener('input', function() {
            showContacts(this.value);
        });

        // Hide results when clicking outside
        document.addEventListener('click', function(e) {
            if (!contactSearch.contains(e.target) && !contactResults.contains(e.target)) {
                contactResults.classList.add('hidden');
            }
        });

        // Prevent form submit if no contact selected
        linkContactForm.addEventListener('submit', function(e) {
            if (!contactIdInput.value) {
                e.preventDefault();
                alert('Please search and select a contact first.');
            }
        });
    }

    function selectContact(id, name, email) {
        contactIdInput.value = id;
        contactSearch.value = name + (email ? ' (' + email + ')' : '');
        contactResults.classList.add('hidden');
    }
</script>
{% endblock %}
